{"ast":null,"code":"import { Util } from 'leaflet';\nimport { RasterLayer } from './RasterLayer';\nimport { getUrlParams } from '../Util';\nimport mapService from '../Services/MapService';\nexport var DynamicMapLayer = RasterLayer.extend({\n  options: {\n    updateInterval: 150,\n    layers: false,\n    layerDefs: false,\n    timeOptions: false,\n    format: 'png32',\n    transparent: true,\n    f: 'json'\n  },\n  initialize: function (options) {\n    options = getUrlParams(options);\n    this.service = mapService(options);\n    this.service.addEventParent(this);\n    Util.setOptions(this, options);\n  },\n  getDynamicLayers: function () {\n    return this.options.dynamicLayers;\n  },\n  setDynamicLayers: function (dynamicLayers) {\n    this.options.dynamicLayers = dynamicLayers;\n    this._update();\n    return this;\n  },\n  getLayers: function () {\n    return this.options.layers;\n  },\n  setLayers: function (layers) {\n    this.options.layers = layers;\n    this._update();\n    return this;\n  },\n  getLayerDefs: function () {\n    return this.options.layerDefs;\n  },\n  setLayerDefs: function (layerDefs) {\n    this.options.layerDefs = layerDefs;\n    this._update();\n    return this;\n  },\n  getTimeOptions: function () {\n    return this.options.timeOptions;\n  },\n  setTimeOptions: function (timeOptions) {\n    this.options.timeOptions = timeOptions;\n    this._update();\n    return this;\n  },\n  query: function () {\n    return this.service.query();\n  },\n  identify: function () {\n    return this.service.identify();\n  },\n  find: function () {\n    return this.service.find();\n  },\n  _getPopupData: function (e) {\n    var callback = Util.bind(function (error, featureCollection, response) {\n      if (error) {\n        return;\n      } // we really can't do anything here but authenticate or requesterror will fire\n      setTimeout(Util.bind(function () {\n        this._renderPopup(e.latlng, error, featureCollection, response);\n      }, this), 300);\n    }, this);\n    var identifyRequest;\n    if (this.options.popup) {\n      identifyRequest = this.options.popup.on(this._map).at(e.latlng);\n    } else {\n      identifyRequest = this.identify().on(this._map).at(e.latlng);\n    }\n\n    // remove extraneous vertices from response features if it has not already been done\n    if (!identifyRequest.params.maxAllowableOffset) {\n      identifyRequest.simplify(this._map, 0.5);\n    }\n    if (!(this.options.popup && this.options.popup.params && this.options.popup.params.layers)) {\n      if (this.options.layers) {\n        identifyRequest.layers('visible:' + this.options.layers.join(','));\n      } else {\n        identifyRequest.layers('visible');\n      }\n    }\n\n    // if present, pass layer ids and sql filters through to the identify task\n    if (this.options.layerDefs && typeof this.options.layerDefs !== 'string' && !identifyRequest.params.layerDefs) {\n      for (var id in this.options.layerDefs) {\n        if (Object.prototype.hasOwnProperty.call(this.options.layerDefs, id)) {\n          identifyRequest.layerDef(id, this.options.layerDefs[id]);\n        }\n      }\n    }\n    identifyRequest.run(callback);\n\n    // set the flags to show the popup\n    this._shouldRenderPopup = true;\n    this._lastClick = e.latlng;\n  },\n  _buildExportParams: function () {\n    var sr = parseInt(this._map.options.crs.code.split(':')[1], 10);\n    var params = {\n      bbox: this._calculateBbox(),\n      size: this._calculateImageSize(),\n      dpi: 96,\n      format: this.options.format,\n      transparent: this.options.transparent,\n      bboxSR: sr,\n      imageSR: sr\n    };\n    if (this.options.dynamicLayers) {\n      params.dynamicLayers = this.options.dynamicLayers;\n    }\n    if (this.options.layers) {\n      if (this.options.layers.length === 0) {\n        return;\n      } else {\n        params.layers = 'show:' + this.options.layers.join(',');\n      }\n    }\n    if (this.options.layerDefs) {\n      params.layerDefs = typeof this.options.layerDefs === 'string' ? this.options.layerDefs : JSON.stringify(this.options.layerDefs);\n    }\n    if (this.options.timeOptions) {\n      params.timeOptions = JSON.stringify(this.options.timeOptions);\n    }\n    if (this.options.from && this.options.to) {\n      params.time = this.options.from.valueOf() + ',' + this.options.to.valueOf();\n    }\n    if (this.service.options.token) {\n      params.token = this.service.options.token;\n    }\n    if (this.options.proxy) {\n      params.proxy = this.options.proxy;\n    }\n\n    // use a timestamp to bust server cache\n    if (this.options.disableCache) {\n      params._ts = Date.now();\n    }\n    return params;\n  },\n  _requestExport: function (params, bounds) {\n    if (this.options.f === 'json') {\n      this.service.request('export', params, function (error, response) {\n        if (error) {\n          return;\n        } // we really can't do anything here but authenticate or requesterror will fire\n\n        if (this.options.token && response.href) {\n          response.href += '?token=' + this.options.token;\n        }\n        if (this.options.proxy && response.href) {\n          response.href = this.options.proxy + '?' + response.href;\n        }\n        if (response.href) {\n          this._renderImage(response.href, bounds);\n        } else {\n          this._renderImage(response.imageData, bounds, response.contentType);\n        }\n      }, this);\n    } else {\n      params.f = 'image';\n      var fullUrl = this.options.url + 'export' + Util.getParamString(params);\n      if (this.options.proxy) {\n        fullUrl = this.options.proxy + '?' + fullUrl;\n      }\n      this._renderImage(fullUrl, bounds);\n    }\n  }\n});\nexport function dynamicMapLayer(url, options) {\n  return new DynamicMapLayer(url, options);\n}\nexport default dynamicMapLayer;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}