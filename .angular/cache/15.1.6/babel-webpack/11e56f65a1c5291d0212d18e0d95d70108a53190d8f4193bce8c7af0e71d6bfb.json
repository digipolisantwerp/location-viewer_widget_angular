{"ast":null,"code":"import { CRS, DomEvent, TileLayer, Util } from 'leaflet';\nimport { warn, getUrlParams, setEsriAttribution, removeEsriAttribution } from '../Util';\nimport mapService from '../Services/MapService';\nexport var TiledMapLayer = TileLayer.extend({\n  options: {\n    zoomOffsetAllowance: 0.1,\n    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEABAMAAACuXLVVAAAAA1BMVEUzNDVszlHHAAAAAXRSTlMAQObYZgAAAAlwSFlzAAAAAAAAAAAB6mUWpAAAADZJREFUeJztwQEBAAAAgiD/r25IQAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7waBAAABw08RwAAAAABJRU5ErkJggg=='\n  },\n  statics: {\n    MercatorZoomLevels: {\n      0: 156543.03392799999,\n      1: 78271.516963999893,\n      2: 39135.758482000099,\n      3: 19567.879240999901,\n      4: 9783.9396204999593,\n      5: 4891.9698102499797,\n      6: 2445.9849051249898,\n      7: 1222.9924525624899,\n      8: 611.49622628138002,\n      9: 305.74811314055802,\n      10: 152.874056570411,\n      11: 76.437028285073197,\n      12: 38.218514142536598,\n      13: 19.109257071268299,\n      14: 9.5546285356341496,\n      15: 4.7773142679493699,\n      16: 2.38865713397468,\n      17: 1.1943285668550501,\n      18: 0.59716428355981699,\n      19: 0.29858214164761698,\n      20: 0.14929107082381,\n      21: 0.07464553541191,\n      22: 0.0373227677059525,\n      23: 0.0186613838529763\n    }\n  },\n  initialize: function (options) {\n    options = Util.setOptions(this, options);\n\n    // set the urls\n    options = getUrlParams(options);\n    this.tileUrl = (options.proxy ? options.proxy + '?' : '') + options.url + 'tile/{z}/{y}/{x}' + (options.requestParams && Object.keys(options.requestParams).length > 0 ? Util.getParamString(options.requestParams) : '');\n    // Remove subdomain in url\n    // https://github.com/Esri/esri-leaflet/issues/991\n    if (options.url.indexOf('{s}') !== -1 && options.subdomains) {\n      options.url = options.url.replace('{s}', options.subdomains[0]);\n    }\n    this.service = mapService(options);\n    this.service.addEventParent(this);\n    var arcgisonline = new RegExp(/tiles.arcgis(online)?\\.com/g);\n    if (arcgisonline.test(options.url)) {\n      this.tileUrl = this.tileUrl.replace('://tiles', '://tiles{s}');\n      options.subdomains = ['1', '2', '3', '4'];\n    }\n    if (this.options.token) {\n      this.tileUrl += '?token=' + this.options.token;\n    }\n\n    // init layer by calling TileLayers initialize method\n    TileLayer.prototype.initialize.call(this, this.tileUrl, options);\n  },\n  getTileUrl: function (tilePoint) {\n    var zoom = this._getZoomForUrl();\n    return Util.template(this.tileUrl, Util.extend({\n      s: this._getSubdomain(tilePoint),\n      x: tilePoint.x,\n      y: tilePoint.y,\n      // try lod map first, then just default to zoom level\n      z: this._lodMap && this._lodMap[zoom] ? this._lodMap[zoom] : zoom\n    }, this.options));\n  },\n  createTile: function (coords, done) {\n    var tile = document.createElement('img');\n    DomEvent.on(tile, 'load', Util.bind(this._tileOnLoad, this, done, tile));\n    DomEvent.on(tile, 'error', Util.bind(this._tileOnError, this, done, tile));\n    if (this.options.crossOrigin) {\n      tile.crossOrigin = '';\n    }\n\n    /*\r\n     Alt tag is set to empty string to keep screen readers from reading URL and for compliance reasons\r\n     http://www.w3.org/TR/WCAG20-TECHS/H67\r\n    */\n    tile.alt = '';\n\n    // if there is no lod map or an lod map with a proper zoom load the tile\n    // otherwise wait for the lod map to become available\n    if (!this._lodMap || this._lodMap && this._lodMap[this._getZoomForUrl()]) {\n      tile.src = this.getTileUrl(coords);\n    } else {\n      this.once('lodmap', function () {\n        tile.src = this.getTileUrl(coords);\n      }, this);\n    }\n    return tile;\n  },\n  onAdd: function (map) {\n    // include 'Powered by Esri' in map attribution\n    setEsriAttribution(map);\n    if (!this._lodMap) {\n      this.metadata(function (error, metadata) {\n        if (!error && metadata.spatialReference) {\n          var sr = metadata.spatialReference.latestWkid || metadata.spatialReference.wkid;\n          // display the copyright text from the service using leaflet's attribution control\n          if (!this.options.attribution && map.attributionControl && metadata.copyrightText) {\n            this.options.attribution = metadata.copyrightText;\n            map.attributionControl.addAttribution(this.getAttribution());\n          }\n\n          // if the service tiles were published in web mercator using conventional LODs but missing levels, we can try and remap them\n          if (map.options.crs === CRS.EPSG3857 && (sr === 102100 || sr === 3857)) {\n            this._lodMap = {};\n            // create the zoom level data\n            var arcgisLODs = metadata.tileInfo.lods;\n            var correctResolutions = TiledMapLayer.MercatorZoomLevels;\n            for (var i = 0; i < arcgisLODs.length; i++) {\n              var arcgisLOD = arcgisLODs[i];\n              for (var ci in correctResolutions) {\n                var correctRes = correctResolutions[ci];\n                if (this._withinPercentage(arcgisLOD.resolution, correctRes, this.options.zoomOffsetAllowance)) {\n                  this._lodMap[ci] = arcgisLOD.level;\n                  break;\n                }\n              }\n            }\n            this.fire('lodmap');\n          } else if (map.options.crs && map.options.crs.code && map.options.crs.code.indexOf(sr) > -1) {\n            // if the projection is WGS84, or the developer is using Proj4 to define a custom CRS, no action is required\n          } else {\n            // if the service was cached in a custom projection and an appropriate LOD hasn't been defined in the map, guide the developer to our Proj4 sample\n            warn('L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet https://developers.arcgis.com/esri-leaflet/samples/non-mercator-projection/');\n          }\n        }\n      }, this);\n    }\n    TileLayer.prototype.onAdd.call(this, map);\n  },\n  onRemove: function (map) {\n    removeEsriAttribution(map);\n    TileLayer.prototype.onRemove.call(this, map);\n  },\n  metadata: function (callback, context) {\n    this.service.metadata(callback, context);\n    return this;\n  },\n  identify: function () {\n    return this.service.identify();\n  },\n  find: function () {\n    return this.service.find();\n  },\n  query: function () {\n    return this.service.query();\n  },\n  authenticate: function (token) {\n    var tokenQs = '?token=' + token;\n    this.tileUrl = this.options.token ? this.tileUrl.replace(/\\?token=(.+)/g, tokenQs) : this.tileUrl + tokenQs;\n    this.options.token = token;\n    this.service.authenticate(token);\n    return this;\n  },\n  _withinPercentage: function (a, b, percentage) {\n    var diff = Math.abs(a / b - 1);\n    return diff < percentage;\n  }\n});\nexport function tiledMapLayer(url, options) {\n  return new TiledMapLayer(url, options);\n}\nexport default tiledMapLayer;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}